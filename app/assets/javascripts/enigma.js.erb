(function(){
  "use strict";
  var backingScale = function() {
    if ('devicePixelRatio' in window) {
      if (window.devicePixelRatio > 1) {
        return window.devicePixelRatio;
      }
    }
    return 1;
  };
  var scaleCanvas = function(ctx, canvas){
    var scaleFactor = backingScale(ctx);
    if (scaleFactor > 1) {
      var oldWidth = canvas.width;
      var oldHeight = canvas.height;
      canvas.width = canvas.width * scaleFactor;
      canvas.height = canvas.height * scaleFactor;
      // update the context for the new canvas scale
      canvas.getContext("2d").scale(scaleFactor, scaleFactor);
      canvas.style.width = oldWidth + "px";
      canvas.style.height = oldHeight + "px";
    }
  };
  var flickerOver = function(){
    $('.flickerIn').css('opacity', '1').removeClass('flickerIn').addClass('flickerOver');
  }
  var CIRCLE = Math.PI * 2;
  var gone = 0;
  var s;
  var loadFullAnimation = true;
  var Enigma = {
    keys: [],
    keyCount: 0,
    validChars: "0123456789ABCDEFGHIJKLMNOPQURSTUVWXYZ",
    interval: 0,
    canvas: 0,
    ctx: 0,
    settings: {
      width: window.innerWidth * 1.2,
      height: window.innerHeight * 1.2,
      size: 22,
      scaledSize: 22 * 4,
      lineWidth: 1.2,
    },
    init: function() {
      s = this.settings;
      Enigma.canvas = document.querySelector('canvas');
      Enigma.canvas.height = s.height;
      Enigma.canvas.width = s.width;
      Enigma.ctx = Enigma.canvas.getContext("2d");
      scaleCanvas(Enigma.ctx, Enigma.canvas);
      for (var i = 0, countX = 0; i <= s.width; countX++, i += s.scaledSize) {
        Enigma.keys[countX] = [];
        for (var j = 0, countY = 0; j <= s.height; countY++, j += s.scaledSize) {
          Enigma.keys[countX][countY] = new Enigma.key(i, j);
        }
      }
      //Start canvas drawing
      var coreLoop = Enigma.startLoop();
      window.setTimeout(function() {
        //Wait for specified time to begin fadeout
        console.log("INIT TIMEOUT FIRING");
        window.fader(coreLoop);
      }, 1500);
      this.userActions(coreLoop);
    },
    key: function(i, j) {
      this.character = Enigma.validChars.substr( Math.floor(Math.random() * 36), 1);
      this.light = 0;
      this.x = i;
      this.y = j;
      this.color = 'rgba(255,255,255,';
        this.id = Enigma.keyCount++;
        this.opacity = '1.0';
      //draw the individual circle
      this.draw = function() {
        if (this.light === -1){ return; }
        if (this.opacity !== '0') {
          if (Math.random() < 0.03) {
            this.opacity = '1';
          } else {
            this.opacity = '.6';
          }
        }
        Enigma.ctx.textAlign = 'center';
        Enigma.ctx.lineWidth = s.lineWidth;
        Enigma.ctx.beginPath();
        Enigma.ctx.strokeStyle = this.color + this.opacity + ')';
        Enigma.ctx.arc(this.x, this.y, s.size, 0, CIRCLE, true);
        Enigma.ctx.closePath();
        if (!this.light){
          Enigma.ctx.stroke();
        }
        Enigma.ctx.font = '14pt source-code-pro, Source Code Pro, sans-serif';
        Enigma.ctx.fillStyle = this.color + this.opacity + ')';
        if (Math.random() > .5) {
          this.character = Enigma.validChars.substr( Math.floor(Math.random() * 36), 1);
        }
        if (this.light > 0 && this.light !== Math.floor(Math.random() * 10)) {
          Enigma.ctx.fillStyle = this.color + this.opacity + ')';
          Enigma.ctx.fill();
          Enigma.ctx.fillStyle = this.color;
        }
        if (this.light > 0){
          this.light--;
        }
        Enigma.ctx.fillText(this.character, this.x + 1, this.y + (s.size / 2.5) - 1);
    };
  },
  lightKey: function(p, delay, duration) {
    window.setTimeout(function(){
      p.light = duration;
    }, Math.random() * delay);
  },
  userActions: function(coreLoop) {
    window.addEventListener('resize', function() {
      Enigma.resizeEvent(coreLoop);
    });
  },
  resizeEvent: function(coreLoop) {
    s.width = window.innerWidth * 1.2;
    s.height = window.innerHeight * 1.2;
    Enigma.canvas.height = s.height;
    Enigma.canvas.width = s.width;
    Enigma.ctx = Enigma.canvas.getContext("2d");
    scaleCanvas(Enigma.ctx, Enigma.canvas);
    for (var i = 0, countX = 0; i <= s.width; countX++, i += s.scaledSize) {
      Enigma.keys[countX] = [];
      for (var j = 0, countY = 0; j <= s.height; countY++, j += s.scaledSize) {
        Enigma.keys[countX][countY] = new Enigma.key(i, j);
      }
    }
    if (gone === 1) {
      console.log("RESIZE EVENT FIRING");
      window.fader(coreLoop);
    }
  },
  startLoop: function() {
    return window.setInterval(function() {
      //continue drawing them
      Enigma.ctx.clearRect(0, 0, Enigma.canvas.width, Enigma.canvas.height);
      for (var i = 0, countX = 0; i <= s.width && countX < Enigma.keys.length; countX++, i += s.scaledSize) {
        for (var j = 0, countY = 0; j <= s.height && countY < Enigma.keys[countX].length; countY++, j += s.scaledSize) {
          Enigma.keys[countX][countY].draw();
        }
      }
      console.log("DRAWING MOAR KEY THINGS");
    }, 105);
  },
  stopLoop: function(flickerInterval, coreInterval) {
    Enigma.keys = [];
    window.clearInterval(coreInterval);
    window.clearInterval(flickerInterval);
    Enigma.canvas = null;
    Enigma = null;
    console.log("STOPPING LOOP");
  },
};
  //fader for logo/circles
  window.fader = function(coreInterval) {
    gone = 1;
    var maxCircleTime = 3000;
    var flickerDelay = 500;
    var flickerStart = maxCircleTime - flickerDelay;
    var flickerDuration = 1050;
    // Circles start dissappearing at
    // t = 0
    // and will all be gone by
    // t = maxCircleTime
    // -------------------
    // Flickering will start at flickerStart and will last for
    // flickerDuration. At this point stopLoop is called with the flicker
    // setInterval handle
    window.setTimeout(function() {
      var flickerInterval = window.setInterval(function() {
          $('.flickerIn').each(function(index, el) {
            var n = Math.random();
            if (n > 0.67){
              $(el).css('opacity', '1');
            } else if (n > 0.33){
              $(el).css('opacity', '0.5');
            } else{
              $(el).css('opacity', '0');
            }
          });
          console.log("FlickerIn Interval");
      }, 105);
      window.setTimeout(function() {
        Enigma.stopLoop(flickerInterval, coreInterval);
        flickerOver();
        console.log("Stoploop timeout");
      }, flickerDuration);
      console.log("2500 timeout");
    }, flickerStart);

    //Clear circles
    for (var i = 0, countX = 0; i <= s.width; countX++, i += s.scaledSize) {
      for (var j = 0, countY = 0; j <= s.height; countY++, j += s.scaledSize) {
        Enigma.lightKey(Enigma.keys[countX][countY], maxCircleTime, -1);
      }
    }
    console.log("window.fader done");
  };
  window.onload = function() {
    if (!window.shouldSkipIntro){
      Enigma.init();
    }
    document.getElementById('bg').className += ' fadeOut';
    if (window.shouldSkipIntro){
      flickerOver();
    }
  };
})();
